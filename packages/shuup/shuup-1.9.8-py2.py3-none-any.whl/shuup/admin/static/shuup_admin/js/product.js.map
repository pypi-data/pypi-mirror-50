{"version":3,"sources":["../base/js/dropzone.js","edit_media.js"],"names":["activateDropzone","$dropzone","attrs","length","selector","attr","$data","$","data","uploadPath","upload_path","addRemoveLinks","add_remove_links","uploadUrl","upload_url","window","ShuupAdminConfig","browserUrls","media","browsable","params","extend","url","csrfmiddlewaretoken","csrf","dictRemoveFile","gettext","autoProcessQueue","uploadMultiple","parallelUploads","maxFiles","dictDefaultMessage","clickable","accept","file","done","kind","type","indexOf","dropzone","Dropzone","on","onAddedFile","files","removeFile","onSuccess","find","val","xhr","JSON","parse","responseText","id","onQueueComplete","noop","BrowseAPI","openBrowseWindow","disabledMenus","filter","onSelect","obj","name","text","remove","emit","thumbnail","fileInput","document","createElement","body","appendChild","prop","css","evt","target","addFile","trigger","push","console","error","activateDropzones","each","idx","object","includes","module","exports","onDropzoneSuccess","$section","addMediaPanel","section","panelCount","$source","$html","html","replace","targetId","$contents","$name","append","prepend","insertBefore","e","preventDefault","confirm","parents","fadeOut","next","$panel","current","split","$imagePanels","removeClass","addClass","replaceWith","i","field","targetPath","queueComplete","forEach","zoneData","fieldId","onDropzoneQueueComplete","location","pathname","productId","product_id","$fileInputs","fileIds","fileId","parseInt","isNaN","ajax","method","file_ids","traditional","success","Messages","enqueue","tags","message","alert"],"mappings":"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","file":"product.js","sourceRoot":"../../../static_src/product","sourcesContent":["/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2019, Shoop Commerce Ltd. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\nfunction activateDropzone($dropzone, attrs={}) {\n    if(!$dropzone.length) {\n        console.error(\"[dropzone.js] Unable to find requested element \", $dropzone);\n        return;\n    }\n\n    const selector = \"#\" + $dropzone.attr(\"id\");\n    const $data = $(selector).data();\n    const uploadPath = attrs.uploadPath || $data.upload_path;\n    const addRemoveLinks = $data.add_remove_links;\n    const uploadUrl = $data.upload_url || window.ShuupAdminConfig.browserUrls.media;\n    const browsable = (window.ShuupAdminConfig.browserUrls[\"media\"] && $data.browsable && $data.browsable !== \"False\");\n    const params = $.extend(true, {\n        url: uploadUrl + \"?action=upload&path=\" + uploadPath,\n        uploadUrl,\n        params: {\n            csrfmiddlewaretoken: window.ShuupAdminConfig.csrf\n        },\n        addRemoveLinks: (addRemoveLinks === \"True\"),\n        dictRemoveFile: gettext(\"Clear\"),\n        autoProcessQueue: true,\n        uploadMultiple: false,\n        parallelUploads: 1,\n        maxFiles: 1,\n        dictDefaultMessage: gettext(\"Drop files here or click to browse.\"),\n        clickable: false,\n        accept: function(file, done) {\n            if ($data.kind === \"images\" && file.type.indexOf(\"image\") < 0) {\n                done(gettext(\"only images can be uploaded!\"));\n            } else {\n                done();\n            }\n        }\n    }, attrs);\n    const dropzone = new Dropzone(selector, params);\n\n    dropzone.on(\"addedfile\", attrs.onAddedFile || function(file) {\n        if(params.maxFiles === 1 && dropzone.files.length > 1) {\n            dropzone.removeFile(dropzone.files[0]);\n        }\n    });\n\n    dropzone.on(\"removedfile\", attrs.onSuccess || function(data){\n        $(selector).find(\"input\").val(\"\");\n    });\n\n    dropzone.on(\"success\", attrs.onSuccess || function(data){\n        // file selected through dnd\n        if(data.xhr) {\n            data = JSON.parse(data.xhr.responseText).file;\n        }\n        $(selector).find(\"input\").val(data.id);\n    });\n\n    dropzone.on(\"queuecomplete\", attrs.onQueueComplete || $.noop);\n\n    $(selector).on(\"click\", function() {\n        if (browsable) {\n            window.BrowseAPI.openBrowseWindow({\n                kind: \"media\",\n                disabledMenus: [\"delete\", \"rename\"],\n                filter: $(selector).data().kind,\n                onSelect: (obj) => {\n                    obj.name = obj.text;\n                    $(selector).find(\"input\").val(obj.id);\n                    $(selector).find(\".dz-preview\").remove();\n                    dropzone.emit(\"addedfile\", obj);\n                    if(obj.thumbnail) {\n                        dropzone.emit(\"thumbnail\", obj, obj.thumbnail);\n                    }\n                    dropzone.emit(\"success\", obj);\n                    dropzone.emit(\"complete\", obj);\n                }\n            });\n        } else {\n            const fileInput = document.createElement(\"input\");\n            document.body.appendChild(fileInput);\n            $(fileInput).prop(\"type\", \"file\").css(\"display\", \"none\").on(\"change\", (evt) => {\n                const file = evt.target.files[0];\n                dropzone.addFile(file);\n                fileInput.remove();\n            }).trigger(\"click\");\n        }\n    });\n\n    const data = $(selector).data();\n    if(data.url) {\n        dropzone.files.push(data);\n        dropzone.emit(\"addedfile\", data);\n        if(data.thumbnail){\n            dropzone.emit(\"thumbnail\", data, data.thumbnail);\n        }\n        dropzone.emit(\"complete\", data);\n    }\n}\n\nwindow.activateDropzones = function() {\n    $(\"div[data-dropzone='true']\").each(function(idx, object) {\n        const dropzone = $(object);\n        if(!dropzone.attr(\"id\").includes(\"__prefix__\") && dropzone.find(\".dz-message\").length === 0) {\n            activateDropzone(dropzone);\n        }\n    });\n};\nwindow.activateDropzone = activateDropzone;\n\n$(function(){\n    window.activateDropzones();\n});\n\nmodule.exports = { activateDropzone }\n","/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2019, Shoop Commerce Ltd. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { activateDropzone } from '../base/js/dropzone';\n\n$(function() {\n    $(\".product-media-delete\").on(\"click\", function(e) {\n        e.preventDefault();\n        if (confirm(gettext(\"Are you sure you want to delete this media?\")))\n        {\n            $(this).parents(\".panel\").fadeOut();\n            $(this).next(\".d-none\").find(\"input\").prop(\"checked\", true);\n        }\n    });\n\n    $(document).on(\"click\", \".set-as-primary\", function(e) {\n        e.preventDefault();\n        const $panel = $(this).parents(\".panel\");\n        const prefix = $panel.data(\"prefix\");\n\n        const [, current] = prefix.split(\"-\");\n\n        const $imagePanels = $(\"#product-images-section .panel\");\n\n        $imagePanels.removeClass(\"panel-selected\").addClass(\"panel-default\");\n\n        $(\".is-primary-image\").replaceWith(function() {\n            return $(\"<a>\", {\"class\": \"set-as-primary btn btn-sm btn-inverse\", \"href\": \"#\"}).text(gettext(\"Set as primary image\"));\n        });\n\n        $imagePanels.each(function(i) {\n            $(\"#id_images-\" + i + \"-is_primary\").prop(\"checked\", false);\n        });\n\n        $(this).replaceWith(function() {\n            return $(\"<span>\", {\"class\": \"is-primary-image\"}).text(gettext(\"Primary image\"));\n        });\n\n        $panel.addClass(\"panel-selected\");\n        $(\"#id_images-\" + current + \"-is_primary\").prop(\"checked\", true);\n    });\n\n    function addMediaPanel($section, file) {\n        const section = $section.attr(\"id\");\n        const panelCount = $(\"#\" + section + \" .panel\").length;\n        const $source = $(\"#\" + section + \"-placeholder-panel\");\n        const $html = $($source.html().replace(/__prefix__/g, panelCount - 1).replace(/__prefix_name__/g, panelCount));\n        let targetId = \"id_images\";\n        if (section.indexOf(\"media\") > 0) {\n            targetId = \"id_media\";\n        }\n        if (file) {\n            let $contents = $(\"<a class='thumbnail-image' href='\" + file.url + \"' target='_blank'></a>\");\n            let $name = \"<h4>\" + file.name + \"</h4>\";\n            if(targetId === \"id_images\") {\n                $contents.append(\"<img src='\" + file.url + \"'>\");\n                $html.find(\".thumbnail\").append($contents);\n            } else {\n                $contents.append(\"<img src='\" + file.url + \"' />\");\n                $html.find(\".extra-fields\").prepend($name);\n            }\n            $html.find(\".file-control\").find(\"input\").val(file.id);\n        }\n        $html.insertBefore($source);\n    }\n\n    function onDropzoneQueueComplete(dropzone, kind) {\n        if(location.pathname.indexOf(\"new\") > 0) {\n            // save product media the traditional way via the save button when creating a new product\n            return;\n        }\n        const productId = $(\"#product-\" + kind + \"-section-dropzone\").data().product_id;\n        const $fileInputs = $(\"#product-\" + kind + \"-section\").find(\".file-control input\");\n        var fileIds = [];\n\n        for(var i = 0; i < $fileInputs.length; i++){\n            let fileId = parseInt($($fileInputs[i]).val());\n            if(!isNaN(fileId)) {\n                fileIds.push(parseInt($($fileInputs[i]).val()));\n            }\n        }\n\n        $.ajax({\n            url: \"/sa/products/\" + productId + \"/media/add/\",\n            method: \"POST\",\n            data: {\n                csrfmiddlewaretoken: ShuupAdminConfig.csrf,\n                product_id: productId,\n                file_ids: fileIds,\n                kind\n            },\n            traditional: true,\n            success: function(data) {\n                window.Messages.enqueue({tags: \"success\", text: data.message});\n            },\n            error: function(data) {\n                alert(\"ERROR\");\n            }\n        });\n    }\n\n    function onDropzoneSuccess($section, file) {\n        // file selected through dnd\n        if(file.xhr) {\n            file = JSON.parse(file.xhr.responseText).file;\n        }\n        addMediaPanel($section, file);\n    }\n    const dropzones = [\n        {\n            field: 'product-images-section',\n            targetPath: \"/products/images\",\n            maxFiles: 10,\n            queueComplete: \"images\"\n        },\n        {\n            field: 'product-media-section',\n            targetPath: \"/products/media\",\n            maxFiles: 10,\n            queueComplete: \"media\"\n        }\n    ];\n    dropzones.forEach(function(zoneData) {\n        var fieldId = \"#\" + zoneData.field + \"-dropzone\";\n        if ($(fieldId).length) {\n            activateDropzone($(fieldId), {\n                uploadPath: zoneData.targetPath,\n                maxFiles: zoneData.maxFiles,\n                onSuccess: function(file) {\n                    onDropzoneSuccess($(\"#\" + zoneData.field), file);\n                },\n                onQueueComplete: function() {\n                    onDropzoneQueueComplete(this, zoneData.queueComplete);\n                }\n            });\n        }\n    });\n});\n"]}