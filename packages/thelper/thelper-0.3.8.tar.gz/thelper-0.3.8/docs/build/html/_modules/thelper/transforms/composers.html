<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>thelper.transforms.composers &#8212; thelper 0.3.8 documentation</title>
    <link rel="stylesheet" href="../../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../../index.html">thelper-0.3.8</a> &#187;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    
        <div class="badge">
            <a href="https://github.com/plstcharles/thelper/">Fork me on GitHub</a>
            <img src="../../../_static/right-red@2x.png">
        </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thelper.transforms.composers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Transformation composers module.</span>

<span class="sd">All transforms should aim to be compatible with both numpy arrays and</span>
<span class="sd">PyTorch tensors. By default, images are processed using ``__call__``,</span>
<span class="sd">meaning that for a given transformation ``t``, we apply it via::</span>

<span class="sd">    image_transformed = t(image)</span>

<span class="sd">All important parameters for an operation should also be passed in the</span>
<span class="sd">constructor and exposed in the operation&#39;s ``__repr__`` function so that</span>
<span class="sd">external parsers can discover exactly how to reproduce their behavior. For</span>
<span class="sd">now, these representations are used for debugging more than anything else.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">torchvision.utils</span>

<span class="kn">import</span> <span class="nn">thelper.utils</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Compose"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.Compose">[docs]</a><span class="k">class</span> <span class="nc">Compose</span><span class="p">(</span><span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Composes several transforms together (with support for invert ops).</span>

<span class="sd">    This interface is fully compatible with ``torchvision.transforms.Compose``.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        | :class:`thelper.transforms.composers.CustomStepCompose`</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Compose.__init__"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.Compose.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transforms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forwards the list of transformations to the base class.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">transforms</span><span class="p">,</span> <span class="s2">&quot;expected transforms to be provided as a non-empty list&quot;</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">]):</span>
            <span class="n">transforms</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">load_transforms</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="n">avoid_transform_wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">transforms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="n">Compose</span><span class="p">)</span> <span class="k">else</span> <span class="n">transforms</span>
            <span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">transforms</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Compose</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">transforms</span><span class="p">)</span></div>

<div class="viewcode-block" id="Compose.invert"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.Compose.invert">[docs]</a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tries to invert the transformations applied to a sample.</span>

<span class="sd">        Will throw if one of the transformations cannot be inverted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;invert&quot;</span><span class="p">),</span> <span class="n">f</span><span class="s2">&quot;missing invert op for transform = {repr(t)}&quot;</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample</span></div>

<div class="viewcode-block" id="Compose.__getitem__"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.Compose.__getitem__">[docs]</a>    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the idx-th operation wrapped by the composer.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">),</span> <span class="s2">&quot;operation index is out of range&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provides print-friendly output for class attributes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">+</span> <span class="s2">&quot;(transforms=[</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> \
            <span class="s2">&quot;,</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">])&quot;</span>

<div class="viewcode-block" id="Compose.set_seed"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.Compose.set_seed">[docs]</a>    <span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the internal seed to use for stochastic ops.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;set_seed&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">set_seed</span><span class="p">):</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></div>

<div class="viewcode-block" id="Compose.set_epoch"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.Compose.set_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">set_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the current epoch number in order to change the behavior of some suboperations.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;invalid epoch value&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;set_epoch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">):</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CustomStepCompose"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.CustomStepCompose">[docs]</a><span class="k">class</span> <span class="nc">CustomStepCompose</span><span class="p">(</span><span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Composes several transforms together based on an epoch schedule.</span>

<span class="sd">    This interface is fully compatible with ``torchvision.transforms.Compose``. It can be useful if</span>
<span class="sd">    some operations should change their behavior over the course of a training session. Note that</span>
<span class="sd">    all epoch indices are assumed to be 0-based.</span>

<span class="sd">    Usage example in Python::</span>

<span class="sd">        # We will scale the resolution of input patches based on an arbitrary schedule</span>
<span class="sd">        # dsize = (16, 16)   if epoch &lt; 2         (16x16 patches before epoch 2)</span>
<span class="sd">        # dsize = (32, 32)   if 2 &lt;= epoch &lt; 4    (32x32 patches before epoch 4)</span>
<span class="sd">        # dsize = (64, 64)   if 4 &lt;= epoch &lt; 8    (64x64 patches before epoch 8)</span>
<span class="sd">        # dsize = (112, 112) if 8 &lt;= epoch &lt; 12   (112x112 patches before epoch 12)</span>
<span class="sd">        # dsize = (160, 160) if 12 &lt;= epoch &lt; 15  (160x160 patches before epoch 15)</span>
<span class="sd">        # dsize = (196, 196) if 15 &lt;= epoch &lt; 18  (196x196 patches before epoch 18)</span>
<span class="sd">        # dsize = (224, 224) if epoch &gt;= 18       (224x224 patches past epoch 18)</span>
<span class="sd">        transforms = CustomStepCompose(milestones={</span>
<span class="sd">            0: thelper.transforms.Resize(dsize=(16, 16)),</span>
<span class="sd">            2: thelper.transforms.Resize(dsize=(32, 32)),</span>
<span class="sd">            4: thelper.transforms.Resize(dsize=(64, 64)),</span>
<span class="sd">            8: thelper.transforms.Resize(dsize=(112, 112)),</span>
<span class="sd">            12: thelper.transforms.Resize(dsize=(160, 160)),</span>
<span class="sd">            15: thelper.transforms.Resize(dsize=(196, 196)),</span>
<span class="sd">            18: thelper.transforms.Resize(dsize=(224, 224)),</span>
<span class="sd">        })</span>
<span class="sd">        for epoch in range(100):</span>
<span class="sd">            transforms.set_epoch(epoch)</span>
<span class="sd">            for sample in loader:</span>
<span class="sd">                sample = transforms(sample)</span>
<span class="sd">                train(...)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        stages: list of epochs where a new scaling factor is to be applied.</span>
<span class="sd">        transforms: list of transformation to apply at each stage.</span>
<span class="sd">        milestones: original milestones map provided in the constructor.</span>
<span class="sd">        epoch: index of the current epoch.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        | :class:`thelper.transforms.composers.Compose`</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CustomStepCompose.__init__"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.CustomStepCompose.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">milestones</span><span class="p">,</span> <span class="n">last_epoch</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Receives the milestone stages (or stage lists), and the initialization state.</span>

<span class="sd">        If the milestones do not include the first epoch (idx = 0), then no transform will be applied</span>
<span class="sd">        until the next specified epoch index. When last_epoch is -1, the training is assumed to start</span>
<span class="sd">        from scratch.</span>

<span class="sd">        Args:</span>
<span class="sd">            milestones: Map of epoch indices tied to transformation stages. Keys must be increasing.</span>
<span class="sd">            last_epoch: The index of last epoch. Default: -1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">milestones</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">&quot;milestones should be provided as a dictionary&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">milestones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">milestones</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span> <span class="ow">or</span> \
                <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">milestones</span><span class="o">.</span><span class="n">keys</span><span class="p">()]),</span> \
                <span class="s2">&quot;milestone stages should all be indices (integers) or strings&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">milestones</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># fixup for json-based config loaders</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">milestones</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">milestones</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">milestones</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">),</span> <span class="s2">&quot;milestone stages should be increasing integers&quot;</span>
        <span class="k">for</span> <span class="n">transforms</span> <span class="ow">in</span> <span class="n">milestones</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">),</span> \
                <span class="s2">&quot;stage transformations should be callable&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">]):</span>
                <span class="n">transforms</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">load_transforms</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="n">avoid_transform_wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transforms</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">milestones</span> <span class="o">=</span> <span class="n">milestones</span>  <span class="c1"># kept only for debug/display purposes</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CustomStepCompose</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">last_epoch</span> <span class="o">+</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="nf">_get_stage_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">bisect</span><span class="o">.</span><span class="n">bisect_right</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="CustomStepCompose.invert"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.CustomStepCompose.invert">[docs]</a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tries to invert the transformations applied to a sample.</span>

<span class="sd">        Will throw if one of the transformations cannot be inverted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_stage_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)]</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">transforms</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">transforms</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;invert&quot;</span><span class="p">),</span> <span class="n">f</span><span class="s2">&quot;missing invert op for transform = {repr(t)}&quot;</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample</span></div>

<div class="viewcode-block" id="CustomStepCompose.__call__"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.CustomStepCompose.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Applies the current stage of transformation operations to a sample.&quot;&quot;&quot;</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_stage_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)]</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">transforms</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span></div>

<div class="viewcode-block" id="CustomStepCompose.__getitem__"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.CustomStepCompose.__getitem__">[docs]</a>    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the idx-th operation wrapped by the composer.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">),</span> <span class="s2">&quot;operation index is out of range&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provides print-friendly output for class attributes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">+</span> <span class="s2">&quot;(milestones={</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> \
            <span class="s2">&quot;,</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="s2">&quot;{str(k)} :{repr(v)}&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">milestones</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">})&quot;</span>

<div class="viewcode-block" id="CustomStepCompose.set_seed"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.CustomStepCompose.set_seed">[docs]</a>    <span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the internal seed to use for stochastic ops.&quot;&quot;&quot;</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_stage_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)]</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">transforms</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;set_seed&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">set_seed</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomStepCompose.set_epoch"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.CustomStepCompose.set_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">set_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the current epoch number in order to change the behavior of some suboperations.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;invalid epoch value&quot;</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_stage_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)]</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">transforms</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;set_epoch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span></div>

<div class="viewcode-block" id="CustomStepCompose.step"><a class="viewcode-back" href="../../../thelper.transforms.html#thelper.transforms.composers.CustomStepCompose.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># used for interface compatibility with LRSchedulers only</span>
        <span class="sd">&quot;&quot;&quot;Advances the epoch tracker in order to change the behavior of some suboperations.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3><a href="../../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../use-cases.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thelper.html">thelper package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Pierre-Luc St-Charles.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.
    </div>
  </body>
</html>