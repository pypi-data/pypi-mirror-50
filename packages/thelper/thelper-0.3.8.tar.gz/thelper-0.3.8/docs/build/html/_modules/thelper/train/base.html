<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>thelper.train.base &#8212; thelper 0.3.8 documentation</title>
    <link rel="stylesheet" href="../../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../../index.html">thelper-0.3.8</a> &#187;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    
        <div class="badge">
            <a href="https://github.com/plstcharles/thelper/">Fork me on GitHub</a>
            <img src="../../../_static/right-red@2x.png">
        </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thelper.train.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Model training/evaluation base interface module.</span>

<span class="sd">This module contains the interface required to train and/or evaluate a model based on different tasks. The trainers</span>
<span class="sd">based on this interface are instantiated in launched sessions based on configuration dictionaries.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">AnyStr</span><span class="p">,</span> <span class="n">Optional</span>  <span class="c1"># noqa: F401</span>

<span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="nn">cv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.optim</span>

<span class="kn">import</span> <span class="nn">thelper.typedefs</span> <span class="k">as</span> <span class="nn">typ</span>  <span class="c1"># noqa: F401</span>
<span class="kn">import</span> <span class="nn">thelper.utils</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Trainer"><a class="viewcode-back" href="../../../thelper.train.html#thelper.train.base.Trainer">[docs]</a><span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Abstract trainer interface that defines basic session i/o and setup operations.</span>

<span class="sd">    This interface defines the general behavior of a training session which includes configuration parsing, tensorboard</span>
<span class="sd">    setup, metrics and goal setup, and loss/optimizer setup. It also provides utilities for uploading models and tensors</span>
<span class="sd">    on specific devices, and for saving the state of a session. This interface should be specialized for every task by</span>
<span class="sd">    implementing the ``train_epoch`` and ``eval_epoch`` functions in a derived class. See</span>
<span class="sd">    :class:`thelper.train.classif.ImageClassifTrainer` for an example.</span>

<span class="sd">    The main parameters that will be parsed by this interface from a configuration dictionary are the following:</span>

<span class="sd">    - ``epochs`` (mandatory if training): number of epochs to train for; one epoch is one iteration over all mini-batches.</span>
<span class="sd">    - ``optimization`` (mandatory if training): sub-dictionary containing types and extra parameters required for</span>
<span class="sd">      instantiating the loss, optimizer, and scheduler objects. See the code of each related loading function for more</span>
<span class="sd">      information on special parameters.</span>
<span class="sd">    - ``save_freq`` (optional, default=1): checkpoint save frequency (will save every epoch multiple of given number).</span>
<span class="sd">    - ``save_raw`` (optional, default=True): specifies whether to save raw types or thelper objects in checkpoints.</span>
<span class="sd">    - ``use_tbx`` (optional, default=False): defines whether to use tensorboardX writers for logging or not.</span>
<span class="sd">    - ``device`` (optional): specifies which device to train/evaluate the model on (default=all available).</span>
<span class="sd">    - ``metrics``: list of metrics to instantiate and update during training/evaluation; see related loading function for</span>
<span class="sd">      more information.</span>
<span class="sd">    - ``monitor``: specifies the name of the metric that should be monitored on the validation set for model improvement.</span>

<span class="sd">    Example configuration file::</span>

<span class="sd">        # ...</span>
<span class="sd">        &quot;trainer&quot;: {</span>
<span class="sd">            # type of trainer to instantiate (linked to task type)</span>
<span class="sd">            &quot;type&quot;: &quot;thelper.train.ImageClassifTrainer&quot;,</span>
<span class="sd">            # train for 40 epochs</span>
<span class="sd">            &quot;epochs&quot;: 40,</span>
<span class="sd">            # save every 5 epochs</span>
<span class="sd">            &quot;save_freq&quot;: 5,</span>
<span class="sd">            # monitor validation accuracy and save best model based on that</span>
<span class="sd">            &quot;monitor&quot;: &quot;accuracy&quot;,</span>
<span class="sd">            # optimization parameters block</span>
<span class="sd">            &quot;optimization&quot;: {</span>
<span class="sd">                # all types &amp; params below provided by PyTorch</span>
<span class="sd">                &quot;loss&quot;: {</span>
<span class="sd">                    &quot;type&quot;: &quot;torch.nn.CrossEntropyLoss&quot;</span>
<span class="sd">                },</span>
<span class="sd">                &quot;optimizer&quot;: {</span>
<span class="sd">                    &quot;type&quot;: &quot;torch.optim.SGD&quot;,</span>
<span class="sd">                    &quot;params&quot;: {</span>
<span class="sd">                        &quot;lr&quot;: 0.1,</span>
<span class="sd">                        &quot;momentum&quot;: 0.9,</span>
<span class="sd">                        &quot;weight_decay&quot;: 1e-06,</span>
<span class="sd">                        &quot;nesterov&quot;: true</span>
<span class="sd">                    }</span>
<span class="sd">                },</span>
<span class="sd">                &quot;scheduler&quot;: {</span>
<span class="sd">                    &quot;type&quot;: &quot;torch.optim.lr_scheduler.StepLR&quot;,</span>
<span class="sd">                    &quot;params&quot;: {</span>
<span class="sd">                        &quot;step_size&quot;: 10,</span>
<span class="sd">                        &quot;step_size&quot;: 0.1</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            },</span>
<span class="sd">            # in this example, we use two consumers in total</span>
<span class="sd">            # (one metric for monitoring, and one for logging)</span>
<span class="sd">            &quot;metrics&quot;: {</span>
<span class="sd">                &quot;accuracy&quot;: {</span>
<span class="sd">                    &quot;type&quot;: &quot;thelper.optim.Accuracy&quot;</span>
<span class="sd">                },</span>
<span class="sd">                &quot;fullreport&quot;: {</span>
<span class="sd">                    &quot;type&quot;: &quot;thelper.train.ClassifReport&quot;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        # ...</span>

<span class="sd">    Attributes:</span>
<span class="sd">        logger: used to output debug/warning/error messages to session log.</span>
<span class="sd">        name: name of the session, used for printing and creating log folders.</span>
<span class="sd">        epochs: number of epochs to train the model for.</span>
<span class="sd">        optimization_config: dictionary of optim-related parameters, parsed at training time.</span>
<span class="sd">        save_freq: frequency of checkpoint saves while training (i.e. save every X epochs).</span>
<span class="sd">        save_raw: specifies whether to save raw types or thelper objects in checkpoints.</span>
<span class="sd">        checkpoint_dir: session checkpoint output directory (located within &#39;save_dir&#39;).</span>
<span class="sd">        use_tbx: defines whether to use tensorboardX writers for logging or not.</span>
<span class="sd">        model: model to train; will be uploaded to target device(s) at runtime.</span>
<span class="sd">        config: full configuration dictionary of the session; will be incorporated into all saved checkpoints.</span>
<span class="sd">        devices: list of (cuda) device IDs to upload the model/tensors to; can be empty if only the CPU is available.</span>
<span class="sd">        monitor: name of the training/validation metric that should be monitored for model improvement.</span>

<span class="sd">    TODO: move static utils to their related modules</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        | :class:`thelper.train.classif.ImageClassifTrainer`</span>
<span class="sd">        | :class:`thelper.train.segm.ImageSegmTrainer`</span>
<span class="sd">        | :class:`thelper.train.detect.ObjDetectTrainer`</span>
<span class="sd">        | :class:`thelper.train.regr.RegressionTrainer`</span>
<span class="sd">        | :func:`thelper.train.utils.create_trainer`</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Trainer.__init__"><a class="viewcode-back" href="../../../thelper.train.html#thelper.train.base.Trainer.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">session_name</span><span class="p">,</span>    <span class="c1"># type: AnyStr</span>
                 <span class="n">save_dir</span><span class="p">,</span>        <span class="c1"># type: AnyStr</span>
                 <span class="n">model</span><span class="p">,</span>           <span class="c1"># type: thelper.typedefs.ModelType</span>
                 <span class="n">task</span><span class="p">,</span>            <span class="c1"># type: thelper.tasks.Task</span>
                 <span class="n">loaders</span><span class="p">,</span>         <span class="c1"># type: thelper.typedefs.MultiLoaderType</span>
                 <span class="n">config</span><span class="p">,</span>          <span class="c1"># type: thelper.typedefs.ConfigDict</span>
                 <span class="n">ckptdata</span><span class="o">=</span><span class="kc">None</span>    <span class="c1"># type: typ.Optional[thelper.typedefs.CheckpointContentType]</span>
                 <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Receives the trainer configuration dictionary, parses it, and sets up the session.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">thelper</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)),</span> <span class="s2">&quot;unknown model object type&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">Task</span><span class="p">),</span> <span class="s2">&quot;unknown task object type&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loaders</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;invalid loaders array&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">&quot;invalid config type&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="c1"># parse basic training config args</span>
        <span class="n">trainer_config</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="s2">&quot;trainer&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;session config dictionary missing &#39;trainer&#39; field&quot;</span><span class="p">)</span>
        <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">save_env_list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="s2">&quot;packages.log&quot;</span><span class="p">))</span>
        <span class="n">train_logger_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="s2">&quot;trainer.log&quot;</span><span class="p">)</span>
        <span class="n">train_logger_format</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(process)s</span><span class="s2">] </span><span class="si">%(levelname)s</span><span class="s2"> : </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">train_logger_fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">train_logger_path</span><span class="p">)</span>
        <span class="n">train_logger_fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">train_logger_format</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_class_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">train_logger_fh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;created training log for session &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">session_name</span><span class="p">)</span>
        <span class="n">logstamp</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_log_stamp</span><span class="p">()</span>
        <span class="n">repover</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">__version__</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_git_stamp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;logstamp = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">logstamp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;version = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">repover</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">session_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_freq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;save_freq&quot;</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_freq</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;checkpoint save frequency should be strictly positive integer&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_raw</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">str2bool</span><span class="p">(</span><span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;save_raw&quot;</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;checkpoints&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output_root_dir</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;output_dir&quot;</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">))</span>
        <span class="n">output_root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_root_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">devices_str</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">([</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="s2">&quot;train_device&quot;</span><span class="p">],</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_devices</span><span class="p">(</span><span class="n">devices_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_eval_iter</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;skip_eval_iter&quot;</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># parse and prepare tbx stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_tbx</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">str2bool</span><span class="p">(</span><span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;use_tbx&quot;</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_tbx</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">tensorboardX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tbx</span> <span class="o">=</span> <span class="n">tensorboardX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;tensorboard init : tensorboard --logdir </span><span class="si">%s</span><span class="s2"> --port &lt;your_port&gt;&quot;</span> <span class="o">%</span> <span class="n">output_root_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_tbx_histograms</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">str2bool</span><span class="p">(</span><span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;skip_tbx_histograms&quot;</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tbx_histogram_freq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;tbx_histogram_freq&quot;</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbx_histogram_freq</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;histogram output frequency should be strictly positive integer&quot;</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">loader</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="n">loaders</span><span class="p">):</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{cname}</span><span class="s2">-{str(platform.node())}-</span><span class="si">{timestr}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="n">cname</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">loader</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="n">cname</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># will be instantiated only when needed based on above path</span>

        <span class="c1"># split loaders</span>
        <span class="n">train_loader</span><span class="p">,</span> <span class="n">valid_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">loaders</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">train_loader</span> <span class="ow">or</span> <span class="n">valid_loader</span> <span class="ow">or</span> <span class="n">test_loader</span><span class="p">),</span> <span class="s2">&quot;must provide at least one loader with available data&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span> <span class="o">=</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">valid_loader</span><span class="p">,</span> <span class="n">test_loader</span>
        <span class="k">if</span> <span class="n">train_loader</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s2">&quot;epochs&quot;</span> <span class="ow">in</span> <span class="n">trainer_config</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">trainer_config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bad trainer config epoch count&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trainer_config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">])</span>
            <span class="c1"># loading optimization stuff later since model needs to be on correct device</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimization_config</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;optimization&quot;</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no training data provided, will run a single epoch on valid/test data&quot;</span><span class="p">)</span>

        <span class="c1"># parse metrics</span>
        <span class="k">assert</span> <span class="s2">&quot;metrics&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trainer_config</span> <span class="ow">or</span> <span class="s2">&quot;base_metrics&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">,</span> \
            <span class="s2">&quot;trainer config should have only one of &#39;metrics&#39; and &#39;base_metrics&#39;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;metrics&quot;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;loading metrics defined in trainer config&quot;</span><span class="p">)</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">create_consumers</span><span class="p">(</span><span class="n">trainer_config</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;base_metrics&quot;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;loading base metrics defined in trainer config&quot;</span><span class="p">)</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">create_consumers</span><span class="p">(</span><span class="n">trainer_config</span><span class="p">[</span><span class="s2">&quot;base_metrics&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span> <span class="o">=</span> \
            <span class="n">deepcopy</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">skey</span><span class="p">,</span> <span class="n">sval</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;train_metrics&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_metrics&quot;</span><span class="p">,</span> <span class="s2">&quot;test_metrics&quot;</span><span class="p">],</span>
                              <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">skey</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">new_metrics</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">create_consumers</span><span class="p">(</span><span class="n">trainer_config</span><span class="p">[</span><span class="n">skey</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">mkey</span><span class="p">,</span> <span class="n">mval</span> <span class="ow">in</span> <span class="n">new_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="n">mkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sval</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;metric name &#39;</span><span class="si">{mkey}</span><span class="s2">&#39; duplicated in set &#39;</span><span class="si">{skey}</span><span class="s2">&#39;&quot;</span>
                    <span class="n">sval</span><span class="p">[</span><span class="n">mkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">mval</span>
                <span class="k">for</span> <span class="n">mkey</span><span class="p">,</span> <span class="n">mval</span> <span class="ow">in</span> <span class="n">sval</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;parsed metric &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mkey</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mval</span><span class="p">)))</span>

        <span class="c1"># check for monitored metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best_epoch</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="s2">&quot;monitor&quot;</span> <span class="ow">in</span> <span class="n">trainer_config</span> <span class="ow">and</span> <span class="n">trainer_config</span><span class="p">[</span><span class="s2">&quot;monitor&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">trainer_config</span><span class="p">[</span><span class="s2">&quot;monitor&quot;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">in</span> <span class="n">mset</span> <span class="k">for</span> <span class="n">mset</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">]]),</span> \
                <span class="n">f</span><span class="s2">&quot;metric with name &#39;</span><span class="si">{self.monitor}</span><span class="s2">&#39; could not be found in training/validation metrics&quot;</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span> \
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">]</span>  <span class="c1"># makes no sense to search for it in test metrics...</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">),</span> \
                <span class="s2">&quot;monitoring target should be an actual &#39;metric&#39; class that returns a scalar!&quot;</span>
            <span class="k">assert</span> <span class="n">metric</span><span class="o">.</span><span class="n">goal</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">minimize</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">maximize</span><span class="p">],</span> \
                <span class="s2">&quot;monitored metric does not return proper optimization goal&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_goal</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">goal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">minimize</span> <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">goal</span> <span class="o">==</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">maximize</span> \
                <span class="k">else</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">maximize</span>

        <span class="c1"># parse checkpoint data from previous run (if available)</span>
        <span class="n">ckptdata</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">ckptdata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ckptdata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;monitor_best&quot;</span><span class="p">,</span> <span class="n">ckptdata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best_epoch</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;monitor_best_epoch&quot;</span><span class="p">,</span> <span class="n">ckptdata</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_state</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="n">ckptdata</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_state</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;scheduler&quot;</span><span class="p">,</span> <span class="n">ckptdata</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_iter</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;iter&quot;</span><span class="p">,</span> <span class="n">ckptdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">ckptdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;outputs&quot;</span><span class="p">,</span> <span class="n">ckptdata</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># parse callbacks (see ``thelper.typedefs.IterCallbackType`` and ``thelper.typedefs.IterCallbackParams`` definitions)</span>
        <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">mset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">]):</span>
            <span class="c1"># parse user (custom) callback</span>
            <span class="n">user_callback_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{cname}</span><span class="s2">_iter_callback&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{cname}</span><span class="s2">_callback&quot;</span><span class="p">,</span> <span class="s2">&quot;callback&quot;</span><span class="p">]</span>
            <span class="n">user_callback</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="n">user_callback_keys</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">)</span>  <span class="c1"># type: typ.IterCallbackType</span>
            <span class="n">user_callback_kwargs_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{cname}</span><span class="s2">_iter_callback_kwargs&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{cname}</span><span class="s2">_callback_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;callback_kwargs&quot;</span><span class="p">]</span>
            <span class="n">user_callback_kwargs</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="n">user_callback_kwargs_keys</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">user_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="s2">&quot;user_callback&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mset</span><span class="p">,</span> <span class="s2">&quot;metrics set already had a &#39;user_callback&#39; in it&quot;</span>
                <span class="n">mset</span><span class="p">[</span><span class="s2">&quot;user_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">PredictionCallback</span><span class="p">(</span><span class="n">user_callback</span><span class="p">,</span> <span class="n">user_callback_kwargs</span><span class="p">)</span>
            <span class="c1"># parse display callback</span>
            <span class="n">display_flag_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;display_</span><span class="si">{cname}</span><span class="s2">_preds&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;display_</span><span class="si">{cname}</span><span class="s2">_predictions&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;display_</span><span class="si">{cname}</span><span class="s2">&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;display_preds&quot;</span><span class="p">,</span> <span class="s2">&quot;display_predictions&quot;</span><span class="p">,</span> <span class="s2">&quot;display&quot;</span><span class="p">]</span>
            <span class="n">display_flag</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="n">display_flag_keys</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">display_kwargs_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;display_</span><span class="si">{cname}</span><span class="s2">_preds_kwargs&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;display_</span><span class="si">{cname}</span><span class="s2">_predictions_kwargs&quot;</span><span class="p">,</span>
                                   <span class="n">f</span><span class="s2">&quot;display_</span><span class="si">{cname}</span><span class="s2">_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;display_preds_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;display_predictions_kwargs&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;display_kwargs&quot;</span><span class="p">]</span>
            <span class="n">display_kwargs</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="n">display_kwargs_keys</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">display_flag</span><span class="p">:</span>
                <span class="k">assert</span> <span class="s2">&quot;display_callback&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mset</span><span class="p">,</span> <span class="s2">&quot;metrics set already had a &#39;display_callback&#39; in it&quot;</span>
                <span class="n">display_kwargs</span><span class="p">[</span><span class="s2">&quot;output_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="n">cname</span><span class="p">]</span>
                <span class="n">display_kwargs</span><span class="p">[</span><span class="s2">&quot;save&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">([</span><span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="s2">&quot;save_draw&quot;</span><span class="p">,</span> <span class="s2">&quot;save_draw_output&quot;</span><span class="p">],</span>
                                                                   <span class="n">display_kwargs</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">mset</span><span class="p">[</span><span class="s2">&quot;display_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">PredictionCallback</span><span class="p">(</span><span class="s2">&quot;thelper.train.utils._draw_wrapper&quot;</span><span class="p">,</span>
                                                                                  <span class="n">display_kwargs</span><span class="p">)</span>
            <span class="c1"># add logging callback (will print to console and update iter metric evals)</span>
            <span class="n">logging_kwargs</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key_def</span><span class="p">(</span><span class="s2">&quot;logging_kwargs&quot;</span><span class="p">,</span> <span class="n">trainer_config</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">logging_kwargs</span><span class="p">[</span><span class="s2">&quot;set_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cname</span>
            <span class="n">logging_kwargs</span><span class="p">[</span><span class="s2">&quot;writers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span>  <span class="c1"># pass by ref, will be filled later</span>
            <span class="n">display_kwargs</span><span class="p">[</span><span class="s2">&quot;output_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="n">cname</span><span class="p">]</span>
            <span class="n">mset</span><span class="p">[</span><span class="s2">&quot;logging_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">PredictionCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_logger_callback</span><span class="p">,</span>
                                                                              <span class="n">logging_kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_tbx</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbx</span><span class="o">.</span><span class="n">SummaryWriter</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;config.json&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">writer</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_set_rng_state</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;torch&quot;</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="s2">&quot;torch&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="s2">&quot;torch&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;numpy&quot;</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="s2">&quot;numpy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;random&quot;</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">epoch</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_upload_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dev</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uploads a model to a specific device, wrapping it in ``torch.nn.DataParallel`` if needed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="n">dev</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_move_tensor</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">detach</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uploads a tensor to a specific device.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Trainer</span><span class="o">.</span><span class="n">_move_tensor</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensor</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">Trainer</span><span class="o">.</span><span class="n">_move_tensor</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensor</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tensor</span>  <span class="c1"># ignored (cannot upload)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no reason to have multiple devices if not cuda-enabled GPUs</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="k">if</span> <span class="n">detach</span> <span class="k">else</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_load_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dev</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiates and returns all optimization objects required for training the model.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_config</span>  <span class="c1"># for abbrev only</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">&quot;optimization config should be provided as a dictionary&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="p">,</span> <span class="s2">&quot;optimization only useful with training data&quot;</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># can be omitted if using custom trainer</span>
        <span class="k">if</span> <span class="s2">&quot;loss&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">uploader</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_move_tensor</span><span class="p">,</span> <span class="n">dev</span><span class="o">=</span><span class="n">dev</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">create_loss_fn</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">uploader</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># can be omitted if using custom trainer</span>
        <span class="k">if</span> <span class="s2">&quot;optimizer&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">create_optimizer</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">],</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">scheduler</span><span class="p">,</span> <span class="n">scheduler_step_metric</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;scheduler&quot;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;scheduler&quot;</span><span class="p">]:</span>  <span class="c1"># can always be omitted</span>
            <span class="n">scheduler</span><span class="p">,</span> <span class="n">scheduler_step_metric</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">create_scheduler</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;scheduler&quot;</span><span class="p">],</span> <span class="n">optimizer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">scheduler_step_metric</span>

    <span class="k">def</span> <span class="nf">_load_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices_str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates and returns the list of CUDA devices available on the system.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;loading available devices&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">devices_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">available_cuda_devices</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">devices_str</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)),</span> <span class="s2">&quot;unexpected device string type&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">devices_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">devices_str</span><span class="p">,</span> <span class="s2">&quot;cannot specify empty device name, use &#39;None&#39; to auto-detect&quot;</span>
                <span class="n">devices_str</span> <span class="o">=</span> <span class="n">devices_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">devices_str</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">devices_str</span><span class="p">,</span> <span class="s2">&quot;cannot specify empty device list, use &#39;None&#39; to auto-detect&quot;</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dev_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">dev_str</span> <span class="ow">in</span> <span class="n">devices_str</span><span class="p">]),</span> <span class="s2">&quot;unexpected type in dev list&quot;</span>
            <span class="k">for</span> <span class="n">dev_idx</span><span class="p">,</span> <span class="n">dev_str</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">devices_str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="s2">&quot;cuda&quot;</span> <span class="ow">in</span> <span class="n">dev_str</span> <span class="ow">or</span> <span class="n">dev_str</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span> \
                    <span class="n">f</span><span class="s2">&quot;unknown device type &#39;</span><span class="si">{dev_str}</span><span class="s2">&#39; (expecting &#39;cpu&#39; or &#39;cuda:X&#39;)&quot;</span>
                <span class="k">if</span> <span class="n">dev_str</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices_str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cannot combine cpu with other devices&quot;</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">dev_str</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span> <span class="ow">or</span> <span class="n">dev_str</span> <span class="o">==</span> <span class="s2">&quot;cuda:all&quot;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices_str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;must specify device index (e.g. &#39;cuda:0&#39;) if combining devices&quot;</span>
                    <span class="k">if</span> <span class="n">available_cuda_devices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">available_cuda_devices</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_available_cuda_devices</span><span class="p">()</span>
                    <span class="k">assert</span> <span class="n">available_cuda_devices</span><span class="p">,</span> <span class="s2">&quot;could not find any available cuda devices&quot;</span>
                    <span class="k">return</span> <span class="n">available_cuda_devices</span>
                <span class="k">assert</span> <span class="s2">&quot;cuda:&quot;</span> <span class="ow">in</span> <span class="n">dev_str</span><span class="p">,</span> <span class="s2">&quot;expecting cuda device format to be &#39;cuda:X&#39; (where X is device index)&quot;</span>
                <span class="n">cuda_dev_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dev_str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">available_cuda_devices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">available_cuda_devices</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_available_cuda_devices</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">cuda_dev_idx</span> <span class="ow">in</span> <span class="n">available_cuda_devices</span><span class="p">,</span> \
                    <span class="n">f</span><span class="s2">&quot;cuda device &#39;</span><span class="si">{dev_str}</span><span class="s2">&#39; unavailable (detected devices = {str(available_cuda_devices)})&quot;</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda_dev_idx</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">devices</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_available_cuda_devices</span><span class="p">()</span>

<div class="viewcode-block" id="Trainer.train"><a class="viewcode-back" href="../../../thelper.train.html#thelper.train.base.Trainer.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the training process.</span>

<span class="sd">        This function will train the model until the required number of epochs is reached, and then evaluate it</span>
<span class="sd">        on the test data. The setup of loggers, tensorboard writers is done here, so is model improvement tracking</span>
<span class="sd">        via monitored metrics. However, the code related to loss computation and back propagation is implemented in</span>
<span class="sd">        a derived class via :func:`thelper.train.base.Trainer.train_epoch`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="p">,</span> <span class="s2">&quot;missing training data, invalid loader!&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">ScriptModule</span><span class="p">),</span> <span class="s2">&quot;current impl cannot train model traces&quot;</span>  <span class="c1"># TODO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;uploading model to &#39;</span><span class="si">%s</span><span class="s2">&#39;...&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">scheduler_step_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_optimization</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;loss: {str(loss)}&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;optimizer: {str(optimizer)}&quot;</span><span class="p">)</span>
        <span class="n">latest_loss</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;at epoch#</span><span class="si">%d</span><span class="s2"> for &#39;</span><span class="si">%s</span><span class="s2">&#39; (dev=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">scheduler</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scheduler_step_metric</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">scheduler_step_metric</span> <span class="o">==</span> <span class="s2">&quot;loss&quot;</span><span class="p">:</span>
                        <span class="c1"># todo: use validation loss instead? more stable?</span>
                        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="n">latest_loss</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span> <span class="ow">and</span> <span class="n">scheduler_step_metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">[</span><span class="n">scheduler_step_metric</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span> <span class="ow">and</span> <span class="n">scheduler_step_metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">:</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">[</span><span class="n">scheduler_step_metric</span><span class="p">]</span>
                        <span class="c1"># note: makes no sense to look for it in test metrics</span>
                        <span class="k">assert</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;cannot find metric &#39;</span><span class="si">{scheduler_step_metric}</span><span class="s2">&#39; for scheduler step&quot;</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">),</span> <span class="s2">&quot;monitoring consumer must be metric&quot;</span>
                        <span class="n">metric_anti_goal</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">maximize</span> <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">goal</span> <span class="o">==</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">minimize</span> \
                            <span class="k">else</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">minimize</span>
                        <span class="n">metric_val</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">metric_anti_goal</span>
                        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="n">metric_val</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_tbx_histograms</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbx_histogram_freq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s2">&quot;bn&quot;</span> <span class="ow">in</span> <span class="n">pname</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># skip batch norm modules</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="n">pname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>  <span class="c1"># for proper grouping</span>
                    <span class="k">if</span> <span class="n">pname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;module/&quot;</span><span class="p">):</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="n">pname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;module/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;model/&quot;</span><span class="p">):</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="n">pname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;model/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_histogram</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">grad</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_histogram</span><span class="p">(</span><span class="n">pname</span> <span class="o">+</span> <span class="s1">&#39;/grad&#39;</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;learning rate at </span><span class="si">%.8f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">get_lr</span><span class="p">(</span><span class="n">optimizer</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_rng_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">seeds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="p">,</span> <span class="s2">&quot;set_epoch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="n">latest_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span>
                                           <span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_epoch_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span>
                                     <span class="n">loss</span><span class="o">=</span><span class="n">latest_loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
            <span class="n">train_metric_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric_name</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">)}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train/loss&quot;</span><span class="p">:</span> <span class="n">latest_loss</span><span class="p">,</span> <span class="s2">&quot;train/metrics&quot;</span><span class="p">:</span> <span class="n">train_metric_vals</span><span class="p">}</span>
            <span class="n">monitor_type_key</span> <span class="o">=</span> <span class="s2">&quot;train/metrics&quot;</span>  <span class="c1"># if we cannot run validation, will monitor progression on training metrics</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_rng_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="o">.</span><span class="n">seeds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># force reset here, we always evaluate from a clean state</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="p">,</span> <span class="s2">&quot;set_epoch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eval_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_epoch_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">])</span>
                <span class="n">valid_metric_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric_name</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">)}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;valid/metrics&quot;</span><span class="p">:</span> <span class="n">valid_metric_vals</span><span class="p">}</span>
                <span class="n">monitor_type_key</span> <span class="o">=</span> <span class="s2">&quot;valid/metrics&quot;</span>  <span class="c1"># since validation is available, use that to monitor progression</span>
            <span class="n">new_best</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">monitor_val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">monitor_type_key</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">in</span> <span class="n">value</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;not monitoring required variable &#39;</span><span class="si">{self.monitor}</span><span class="s2">&#39; in metrics&quot;</span>
                    <span class="n">monitor_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_goal</span> <span class="o">==</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">minimize</span> <span class="ow">and</span> <span class="n">monitor_val</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best</span><span class="p">)</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_goal</span> <span class="o">==</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Metric</span><span class="o">.</span><span class="n">maximize</span> <span class="ow">and</span> <span class="n">monitor_val</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best</span> <span class="o">=</span> <span class="n">monitor_val</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span>
                        <span class="n">new_best</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; epoch#</span><span class="si">{}</span><span class="s2"> result =&gt;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">subkey</span><span class="p">,</span> <span class="n">subvalue</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; epoch#</span><span class="si">{}</span><span class="s2"> result =&gt;  </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">subkey</span><span class="p">),</span> <span class="n">subvalue</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">monitor_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;training/validation did not evaluate required metric &#39;</span><span class="si">{self.monitor}</span><span class="s2">&#39;&quot;</span>
                <span class="k">if</span> <span class="n">new_best</span><span class="p">:</span>
                    <span class="n">best_str</span> <span class="o">=</span> <span class="s2">&quot;(new best value)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;(previous best = </span><span class="si">%s</span><span class="s2"> @ epoch = </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_best</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best_epoch</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;epoch </span><span class="si">%d</span><span class="s2">, monitored </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">,</span> <span class="n">monitor_val</span><span class="p">,</span> <span class="n">best_str</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">if</span> <span class="n">new_best</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_freq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;saving checkpoint @ epoch#</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iter</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">save_best</span><span class="o">=</span><span class="n">new_best</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;training for session &#39;</span><span class="si">%s</span><span class="s2">&#39; done&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span></div>

<div class="viewcode-block" id="Trainer.eval"><a class="viewcode-back" href="../../../thelper.train.html#thelper.train.base.Trainer.eval">[docs]</a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the evaluation process.</span>

<span class="sd">        This function will evaluate the model using the test data (or the validation data, if no test data is available),</span>
<span class="sd">        and return the results. Note that the code related to the forwarding of samples inside the model itself is implemented</span>
<span class="sd">        in a derived class via :func:`thelper.train.base.Trainer.eval_epoch`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span><span class="p">,</span> <span class="s2">&quot;missing validation/test data, invalid loaders!&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;uploading model to &#39;</span><span class="si">%s</span><span class="s2">&#39;...&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output_group</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_rng_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span><span class="o">.</span><span class="n">seeds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># force reset here, we always evaluate from a clean state</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span><span class="p">,</span> <span class="s2">&quot;set_epoch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_epoch_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">])</span>
            <span class="n">test_metric_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric_name</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">)}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="p">,</span> <span class="o">**</span><span class="n">test_metric_vals</span><span class="p">}</span>
            <span class="n">output_group</span> <span class="o">=</span> <span class="s2">&quot;test/metrics&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_rng_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="o">.</span><span class="n">seeds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># force reset here, we always evaluate from a clean state</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="p">,</span> <span class="s2">&quot;set_epoch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_epoch_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">writers</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_paths</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">])</span>
            <span class="n">valid_metric_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric_name</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">)}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="p">,</span> <span class="o">**</span><span class="n">valid_metric_vals</span><span class="p">}</span>
            <span class="n">output_group</span> <span class="o">=</span> <span class="s2">&quot;valid/metrics&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; final result =&gt;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">subkey</span><span class="p">,</span> <span class="n">subvalue</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; final result =&gt;  </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">subkey</span><span class="p">),</span> <span class="n">subvalue</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">][</span><span class="n">output_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;evaluation for session &#39;</span><span class="si">%s</span><span class="s2">&#39; done&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span></div>

<div class="viewcode-block" id="Trainer.train_epoch"><a class="viewcode-back" href="../../../thelper.train.html#thelper.train.base.Trainer.train_epoch">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trains the model for a single epoch using the provided objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            model: the model to train that is already uploaded to the target device(s).</span>
<span class="sd">            epoch: the epoch index we are training for (0-based).</span>
<span class="sd">            dev: the target device that tensors should be uploaded to.</span>
<span class="sd">            loss: the loss function used to evaluate model fidelity.</span>
<span class="sd">            optimizer: the optimizer used for back propagation.</span>
<span class="sd">            loader: the data loader used to get transformed training samples.</span>
<span class="sd">            metrics: the dictionary of metrics/consumers to update every iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Trainer.eval_epoch"><a class="viewcode-back" href="../../../thelper.train.html#thelper.train.base.Trainer.eval_epoch">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">eval_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluates the model using the provided objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            model: the model to evaluate that is already uploaded to the target device(s).</span>
<span class="sd">            epoch: the epoch index we are training for (0-based).</span>
<span class="sd">            dev: the target device that tensors should be uploaded to.</span>
<span class="sd">            loader: the data loader used to get transformed valid/test samples.</span>
<span class="sd">            metrics: the dictionary of metrics/consumers to update every iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="k">def</span> <span class="nf">_iter_logger_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># see `thelper.typedefs.IterCallbackParams` for more info</span>
                              <span class="n">task</span><span class="p">,</span>  <span class="c1"># type: thelper.tasks.utils.Task</span>
                              <span class="nb">input</span><span class="p">,</span>  <span class="c1"># type: thelper.typedefs.InputType</span>
                              <span class="n">pred</span><span class="p">,</span>  <span class="c1"># type: thelper.typedefs.PredictionType</span>
                              <span class="n">target</span><span class="p">,</span>  <span class="c1"># type: thelper.typedefs.TargetType</span>
                              <span class="n">sample</span><span class="p">,</span>  <span class="c1"># type: thelper.typedefs.SampleType</span>
                              <span class="n">loss</span><span class="p">,</span>  <span class="c1"># type: Optional[float]</span>
                              <span class="n">iter_idx</span><span class="p">,</span>  <span class="c1"># type: int</span>
                              <span class="n">max_iters</span><span class="p">,</span>  <span class="c1"># type: int</span>
                              <span class="n">epoch_idx</span><span class="p">,</span>  <span class="c1"># type: int</span>
                              <span class="n">max_epochs</span><span class="p">,</span>  <span class="c1"># type: int</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># type: (...) -&gt; None</span>
        <span class="sd">&quot;&quot;&quot;Receives callback data for logging loss/monitored metric values each training/eval iteration.&quot;&quot;&quot;</span>
        <span class="n">set_name</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="s2">&quot;set_name&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;missing set name in iter logger args&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="s2">&quot;unrecognized iter logger set name&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_metrics</span> <span class="k">if</span> <span class="n">set_name</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_metrics</span> <span class="k">if</span> <span class="n">set_name</span> <span class="o">==</span> <span class="s2">&quot;valid&quot;</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_metrics</span>
        <span class="n">writers</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="s2">&quot;writers&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;missing writers dict in iter logger args&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="n">writers</span><span class="p">,</span> <span class="s2">&quot;expected set name writer match in kwargs&quot;</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">writers</span><span class="p">[</span><span class="n">set_name</span><span class="p">]</span>
        <span class="n">monitor_val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">monitor_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">],</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">),</span> <span class="s2">&quot;unexpected metric type&quot;</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">]</span><span class="o">.</span><span class="n">live_eval</span><span class="p">:</span>
                <span class="n">monitor_val</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                <span class="n">monitor_str</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;   </span><span class="si">{self.monitor}</span><span class="s2">: </span><span class="si">{monitor_val:.2f}</span><span class="s2">&quot;</span>
        <span class="n">loss_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loss_str</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;   loss: </span><span class="si">{loss:.6f}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">==</span> <span class="n">epoch_idx</span><span class="p">,</span> <span class="s2">&quot;something&#39;s messed up&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">&quot;</span><span class="si">{set_name}</span><span class="s2"> epoch#</span><span class="si">{epoch_idx}</span><span class="s2">  (iter#</span><span class="si">{self.current_iter}</span><span class="s2">)&quot;</span> <span class="o">+</span>
            <span class="n">f</span><span class="s2">&quot;   batch: {iter_idx + 1}/</span><span class="si">{max_iters}</span><span class="s2"> ({((iter_idx + 1) / max_iters) * 100.0:.0f}%)&quot;</span> <span class="o">+</span>
            <span class="n">f</span><span class="s2">&quot;</span><span class="si">{loss_str}{monitor_str}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s2">&quot;iter/loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iter</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">and</span> <span class="n">monitor_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s2">&quot;iter/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">,</span> <span class="n">monitor_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iter</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">live_eval</span><span class="p">:</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s2">&quot;iter/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_name</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_iter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_write_epoch_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">tbx_writer</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes the cumulative evaluation result of all metrics using a specific writer.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;writing epoch metrics to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">output_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tbx_writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tbx_writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s2">&quot;epoch/loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="n">tbx_writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s2">&quot;epoch/lr&quot;</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">get_lr</span><span class="p">(</span><span class="n">optimizer</span><span class="p">),</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tbx_writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tbx_writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s2">&quot;epoch/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;render&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">render</span><span class="p">):</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tbx_writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tbx_writer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">dataformats</span><span class="o">=</span><span class="s2">&quot;HWC&quot;</span><span class="p">)</span>
                    <span class="n">raw_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%04d</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
                    <span class="n">raw_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">raw_filename</span><span class="p">)</span>
                    <span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">raw_filepath</span><span class="p">,</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">report</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">report</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">txt</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">thelper</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">):</span>
                <span class="n">eval_res</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">eval_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eval_res</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_res</span>  <span class="c1"># make sure we always have decent precision</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">txt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">eval_res</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">txt</span><span class="p">:</span>
                <span class="n">raw_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%04d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
                <span class="n">raw_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">raw_filename</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">raw_filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">save_best</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves a session checkpoint containing all the information required to resume training.&quot;&quot;&quot;</span>
        <span class="c1"># logically, this should only be called during training (i.e. with a valid optimizer)</span>
        <span class="n">log_stamp</span> <span class="o">=</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_log_stamp</span><span class="p">()</span>
        <span class="c1"># the saved state below should be kept compatible with the one in thelper.cli.export_model</span>
        <span class="n">curr_state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
            <span class="s2">&quot;iter&quot;</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">log_stamp</span><span class="p">,</span>
            <span class="s2">&quot;git_sha1&quot;</span><span class="p">:</span> <span class="n">thelper</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_git_stamp</span><span class="p">(),</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">thelper</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
            <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_raw</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span>
            <span class="c1"># we save model type/params here in case those are not in the current config</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_raw</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
            <span class="s2">&quot;model_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="p">{},</span>
            <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                                                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="s2">&quot;state_dict&quot;</span><span class="p">))</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;monitor_best&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best</span><span class="p">,</span>
            <span class="s2">&quot;monitor_best_epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_best_epoch</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>  <span class="c1"># note: this is the global app config</span>
        <span class="p">}</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;ckpt.</span><span class="si">%04d</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.pth&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">log_stamp</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;writing checkpoint to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">curr_state</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_best</span><span class="p">:</span>
            <span class="n">filename_best</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="s2">&quot;ckpt.best.pth&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;writing checkpoint to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">filename_best</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">curr_state</span><span class="p">,</span> <span class="n">filename_best</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3><a href="../../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../use-cases.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thelper.html">thelper package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Pierre-Luc St-Charles.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.
    </div>
  </body>
</html>