language: python
dist: xenial

stages:
- baseline
- name: test
  if: repo = pytest-dev/execnet AND tag IS NOT present
- name: deploy
  if: repo = pytest-dev/execnet AND tag IS present

python:
  - '3.7'

jobs:
  include:
    - stage: baseline
      env: TOXENV=docs
      python: '3.6'
    - env: TOXENV=py27
      python: '2.7'
    - env: TOXENV=py37
      python: '3.7'

    - stage: test
      env: TOXENV=py34
      python: '3.4'
    - env: TOXENV=py35
      python: '3.5'
    - env: TOXENV=py36
      python: '3.6'
    - env: TOXENV=pypy
      python: 'pypy2.7-6.0'
    - env: TOXENV=pypy3
      python: 'pypy3.5-6.0'

    - stage: deploy
      python: '3.7'
      install: pip install -U setuptools setuptools_scm
      script: skip
      deploy:
        provider: pypi
        user: nicoddemus
        distributions: sdist bdist_wheel
        skip_upload_docs: true
        password:
          secure: "l+Khw6WjS1tX+jQ2sGLneAXB7iRKctBx1SnU9jCnRHj1VEN3FhNSKkwaHOvUM56WaPS8Z6KZeDzd4qk0o8bSz+ee+ofpODX+ueherWh3I5pBXdgVC9mpFO5hznBxqSDE/9dvCfPnjed8FE3uMICLxB+0A45zZONaMp1SWSTorOJ7t6MJ9YJwefiCW2Jsw8qcNDJlF2jUzfpOOOMhN824v9R57/o8UnXle9RwqqClq/7OMNqDtFGdYbbLgxoS7RxiknyJ+kRG95bxF/lknPcRrOkpSL+xNcweiFA/cNlz/JQrh6j7HCvUfQYkHAT64CuderUcAHOLhwTDf56j6DSoArxrNKN8vg0wsMqw9wpHI/MmSrw0LMN8MpHXRF902K+DPgxn/yNyJTKR4E3ZZEpJDIYf3Z1K15I2Px/K11r42wP3ulo6yEX7PX6qgPgsRhQuiI8MLrdFnfAjSSWunUsIUGOzO5q/gzaFLT8XlIGI6exuUlyYJfu9Fhtd3PSuEUnxuvEbWLrhOTUfCtVdq9aNV0NiF1bVjPcA0UawD5XUzH7rfBXbkcSHK12C/HzOGUR5UlNeiHnOSVx7FBy7OqbS7/5aBYWtkrAB1cIuhNLJSjOCzGphKvjQtxBja1iJk0atSS4kEKra723rlOZZ6r75bdL9QhB/P5YEnWTIVMbkPZ0="
        on:
          tags: true
          repo: pytest-dev/execnet
  allow_failures:
  - env: TOXENV=pypy
    python: 'pypy2.7-6.0'
  - env: TOXENV=pypy3
    python: 'pypy3.5-6.0'


matrix:
  include:
    - env: TOXENV=docs
      python: '3.6'
  allow_failures:
    - python: 'pypy'

install:
  - pip install -U pip
  - pip install -U setuptools setuptools_scm tox

script:
  - tox

notifications:
  irc:
    channels:
      - "chat.freenode.net#pylib"
    on_success: change
    on_failure: change
    skip_join: true
